apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: glueops-platform-ingress-traefik
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    name: "in-cluster"
    namespace: glueops-core-glueops-platform-ingress-traefik
  project: glueops-core
  syncPolicy:
    syncOptions:
      - CreateNamespace=true  
    automated:
      prune: true
      selfHeal: true
    retry:
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 3m0s
      limit: 5
  source:
    repoURL: 'https://traefik.github.io/charts'
    chart: traefik
    targetRevision: 32.1.1
    helm:
      values: |-
        # RBAC configuration
        rbac:
          enabled: true
          namespaced: false
        
        deployment:
          replicas: {{ .Values.nginx.controller_replica_count }}
          minReadySeconds: 180
          
        
        # IngressClass configuration
        ingressClass:
          enabled: true
          isDefaultClass: false
          name: glueops-platform
        
        # Ports configuration
        ports:
          web:
            port: 80
          websecure:
            port: 443
            http3:
              enabled: false
            tls:
              enabled: true
              # Default certificate via TLS store
              options: ""
              certResolver: ""
              domains: []
        
        # Service configuration
        service:
          type: "LoadBalancer"
          labels: 
            use-as-loadbalancer: platform
            gluekube-dns: platform-lb.{{ .Values.captain_domain }}
              
        # Providers configuration
        providers:
          kubernetesCRD:
            enabled: true
            allowCrossNamespace: true
            allowExternalNameServices: true
          kubernetesIngress:
            enabled: true
            allowCrossNamespace: true
            allowExternalNameServices: true
            publishedService:
              enabled: true
            
        # Additional arguments
        additionalArguments:
          - "--providers.kubernetesingress.ingressclass=glueops-platform"
          - "--serversTransport.forwardingTimeouts.dialTimeout=30s"
          - "--serversTransport.forwardingTimeouts.responseHeaderTimeout=0s"
          - "--serversTransport.forwardingTimeouts.idleConnTimeout=90s"
        
        # Global arguments
        globalArguments:
          - "--global.checknewversion=false"
          - "--global.sendanonymoususage=false"
        
        # Logs configuration (JSON format similar to nginx)
        logs:
          general:
            level: INFO
          access:
            enabled: true
            format: json
            fields:
              general:
                defaultmode: keep
              headers:
                defaultmode: keep
        
        # Metrics and monitoring
        metrics:
          prometheus:
            enabled: true
            service:
              enabled: true
            serviceMonitor:
              enabled: true
        # -- nodeSelector is the simplest recommended form of node selection constraint.
        nodeSelector:
          use-as-loadbalancer: platform
        
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: traefik
                topologyKey: kubernetes.io/hostname
        
        tolerations:
          - key: "glueops.dev/role"
            operator: "Equal"
            value: "glueops-platform"
            effect: "NoSchedule"

        # Extra objects to create TLSStore for default certificate
        extraObjects:
          - apiVersion: traefik.io/v1alpha1
            kind: TLSStore
            metadata:
              name: default
              namespace: glueops-core-glueops-platform-ingress-traefik
            spec:
              defaultCertificate:
                secretName: {{ .Values.certManager.name_of_default_certificate }}
          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: auth-headers
              namespace: glueops-core-oauth2-proxy
            spec:
              headers:
                stsSeconds: 315360000
                browserXssFilter: true
                contentTypeNosniff: true
                forceSTSHeader: true
                stsIncludeSubdomains: true
                stsPreload: true
                frameDeny: true
          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: ssl-redirect
              namespace: glueops-core-oauth2-proxy
            spec:
              redirectScheme:
                scheme: https
                permanent: true

          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: oauth-errors
              namespace: glueops-core-oauth2-proxy

            spec:
              errors:
                status:
                  - "401-403"
                service:
                  name: oauth2-proxy # This must match a valid Kubernetes Service name
                  port: 80            # The port of your oauth-backend service
                query: "/oauth2/start?rd={url}"
          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: oauth-auth
              namespace: glueops-core-oauth2-proxy

            spec:
              forwardAuth:
                address: https://oauth2.{{ .Values.captain_domain }}/oauth2/auth
                trustForwardHeader: true
                authRequestHeaders:
                  - Cookie
                  - Authorization
            
          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: secure-oauth-chain
              namespace: glueops-core-oauth2-proxy

            spec:
              chain:
                middlewares:
                - name: auth-headers
                - name: ssl-redirect
                - name: oauth-errors # Error middleware should usually wrap the auth
                - name: oauth-auth